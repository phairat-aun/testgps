<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Delivery App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- LeafletJS for Interactive Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body { font-family: 'Inter', 'Kanit', sans-serif; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-primary { background: linear-gradient(to right, #FF8C00, #FFA500); color: white; font-weight: bold; border-radius: 0.75rem; padding: 0.75rem 1.5rem; }
        .btn-secondary { background-color: #f3f4f6; color: #1f2937; border: 1px solid #d1d5db; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 1rem; width: 90%; max-width: 400px; }
        #map { height: 250px; border-radius: 0.75rem; border: 1px solid #e5e7eb; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading, App Header, Menu, Cart, Order Summary are the same -->
    <div id="loading" class="flex items-center justify-center h-screen"><div class="text-center"><i class="fas fa-spinner fa-spin text-4xl text-orange-500"></i><p class="mt-2 text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div></div>
    <div id="app" class="hidden max-w-lg mx-auto pb-24">
        <div class="p-4 bg-white shadow-md sticky top-0 z-10"><div class="flex items-center space-x-4"><img id="userPicture" class="w-12 h-12 rounded-full border-2 border-orange-400" src="https://placehold.co/100x100/EFEFEF/AAAAAA?text=User" alt="User Profile Picture"><div><p class="text-gray-600 text-sm">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö</p><h1 id="userName" class="text-lg font-bold text-gray-800">...</h1></div></div></div>
        <div class="p-4"><h2 class="text-2xl font-bold text-gray-800 mb-4">‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h2><div id="menu-list" class="space-y-4"></div></div>
        <div class="fixed bottom-4 right-4"><button id="cartBtn" class="relative bg-orange-500 text-white p-4 rounded-full shadow-lg"><i class="fas fa-shopping-cart text-2xl"></i><span id="cart-badge" class="hidden absolute top-[-5px] right-[-10px] bg-red-500 text-white rounded-full w-6 h-6 text-sm flex items-center justify-center font-bold">0</span></button></div>
        <div id="order-summary" class="hidden fixed bottom-0 left-0 right-0 bg-white p-4 rounded-t-2xl shadow-2xl max-w-lg mx-auto"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2><button id="closeCartBtn"><i class="fas fa-times text-gray-500"></i></button></div><div id="cart-items" class="max-h-40 overflow-y-auto mb-4 space-y-2"></div><div class="flex justify-between items-center font-bold text-lg border-t pt-4"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span><span id="total-price">‡∏ø0</span></div><button id="confirmOrderBtn" class="w-full btn-primary mt-4" disabled><i class="fas fa-arrow-right mr-2"></i>‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button></div>
    </div>

    <!-- Modals (Payment, Bank Transfer) are the same -->
    <div id="payment-modal" class="modal-overlay hidden"><div class="modal-content text-center"><h2 class="text-2xl font-bold mb-6">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2><div class="space-y-4"><button id="cod-btn" class="w-full btn-primary btn-secondary"><i class="fas fa-hand-holding-usd mr-2"></i>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</button><button id="bank-transfer-btn" class="w-full btn-primary"><i class="fas fa-qrcode mr-2"></i>‡πÇ‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</button></div></div></div>
    <div id="bank-transfer-modal" class="modal-overlay hidden"><div class="modal-content text-center"><h2 class="text-2xl font-bold mb-4">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2><p class="mb-4">‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p><img src="https://i.imgur.com/g2344zB.png" alt="QR Code" class="mx-auto mb-4 border rounded-lg"><p class="font-bold text-lg mb-4">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞: <span id="payment-total"></span> ‡∏ö‡∏≤‡∏ó</p><input type="file" id="slip-upload" class="hidden" accept="image/*"><button onclick="document.getElementById('slip-upload').click()" class="w-full btn-primary"><i class="fas fa-upload mr-2"></i>‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button><div id="slip-preview-container" class="hidden mt-4 text-left"><p class="font-semibold">‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö:</p><img id="slip-preview" class="mx-auto max-h-40 rounded mt-2"></div></div></div>
    
    <!-- UPDATED: Address Modal with Interactive Map -->
    <div id="address-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-center">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h2>
            <div id="map" class="mb-4"></div>
            <button id="find-me-btn" class="w-full btn-primary btn-secondary mb-4"><i class="fas fa-location-arrow mr-2"></i>‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
            <div>
                <label for="address-details" class="block font-medium">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / ‡∏ã‡∏≠‡∏¢ / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                <textarea id="address-details" rows="3" class="w-full border border-gray-300 p-2 rounded-md" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 123 ‡∏´‡∏°‡∏π‡πà 4 ‡∏ã‡∏≠‡∏¢ 5"></textarea>
            </div>
            <button id="submit-final-order-btn" class="w-full btn-primary mt-6"><i class="fas fa-paper-plane mr-2"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // State variables and UI elements are mostly the same
            const menuItems = [
                { id: 1, name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö", price: 60, image: "https://i.imgur.com/J8Yf4zL.jpeg" },
                { id: 2, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏õ‡∏π", price: 70, image: "https://i.imgur.com/S21eWzG.jpeg" },
                { id: 3, name: "‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö", price: 60, image: "https://i.imgur.com/L9a2a6E.jpeg" },
                { id: 4, name: "‡∏ú‡∏±‡∏î‡∏ã‡∏µ‡∏≠‡∏¥‡πä‡∏ß", price: 55, image: "https://i.imgur.com/Q3d2m1T.jpeg" },
                { id: 5, name: "‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢", price: 35, image: "https://i.imgur.com/yOa2m9e.jpeg" }
            ];
            let cart = [], paymentMethod = '', locationData = null;
            let map, marker; // Map variables
            const loadingEl=document.getElementById('loading'),appEl=document.getElementById('app'),menuListEl=document.getElementById('menu-list'),cartBtn=document.getElementById('cartBtn'),closeCartBtn=document.getElementById('closeCartBtn'),orderSummaryEl=document.getElementById('order-summary'),cartBadge=document.getElementById('cart-badge'),cartItemsEl=document.getElementById('cart-items'),totalPriceEl=document.getElementById('total-price'),confirmOrderBtn=document.getElementById('confirmOrderBtn'),paymentModal=document.getElementById('payment-modal'),codBtn=document.getElementById('cod-btn'),bankTransferBtn=document.getElementById('bank-transfer-btn'),bankTransferModal=document.getElementById('bank-transfer-modal'),paymentTotalEl=document.getElementById('payment-total'),slipUploadInput=document.getElementById('slip-upload'),slipPreviewContainer=document.getElementById('slip-preview-container'),slipPreviewImg=document.getElementById('slip-preview'),addressModal=document.getElementById('address-modal'),findMeBtn=document.getElementById('find-me-btn'),addressDetailsInput=document.getElementById('address-details'),submitFinalOrderBtn=document.getElementById('submit-final-order-btn');

            async function main() {
                try {
                    await liff.init({ liffId: "2007930661-Meaz8v4l" });
                    if (!liff.isInClient()) { loadingEl.innerHTML = `<p class="text-red-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE</p>`; return; }
                    if (!liff.isLoggedIn()) { liff.login(); return; }
                    const profile = await liff.getProfile();
                    document.getElementById('userName').textContent = profile.displayName;
                    document.getElementById('userPicture').src = profile.pictureUrl;
                    renderMenu();
                    loadingEl.classList.add('hidden');
                    appEl.classList.remove('hidden');
                } catch (error) { console.error('LIFF Init failed', error); }
            }
            function renderMenu() { menuListEl.innerHTML='';menuItems.forEach(i=>{const e=document.createElement('div');e.className='card flex items-center p-3 space-x-4',e.innerHTML=`<img src="${i.image}" alt="${i.name}" class="w-20 h-20 rounded-lg object-cover"><div class="flex-grow"><h3 class="font-bold text-lg">${i.name}</h3><p class="text-gray-600">‡∏ø${i.price}</p></div><button class="btn-add" data-id="${i.id}"><i class="fas fa-plus mr-1"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°</button>`,menuListEl.appendChild(e)})}
            function renderCart() { cartItemsEl.innerHTML='';let t=0,e=0;const n=cart.reduce((i,l)=>{i[l.id]||(i[l.id]={...l,quantity:0}),i[l.id].quantity++;return i},{});0===Object.keys(n).length?(cartItemsEl.innerHTML='<p class="text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>',confirmOrderBtn.disabled=!0):(confirmOrderBtn.disabled=!1,Object.values(n).forEach(i=>{const l=document.createElement('div');l.className='flex justify-between items-center',l.innerHTML=`<div><span class="font-semibold">${i.name}</span><span class="text-gray-500 text-sm"> x${i.quantity}</span></div><span class="font-semibold">‡∏ø${i.price*i.quantity}</span>`,cartItemsEl.appendChild(l)})),cart.forEach(i=>{t+=i.price,e++}),totalPriceEl.textContent=`‡∏ø${t}`,paymentTotalEl.textContent=t,cartBadge.textContent=e,cartBadge.classList.toggle('hidden',0===e)}
            
            // --- NEW: Map Functions ---
            function initializeMap() {
                if (map) return; // Initialize only once
                const initialCoords = [13.7563, 100.5018]; // Default to Bangkok
                map = L.map('map').setView(initialCoords, 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                marker = L.marker(initialCoords, { draggable: true }).addTo(map);
                
                // Update locationData when marker is dragged
                marker.on('dragend', function(event) {
                    const position = marker.getLatLng();
                    locationData = { latitude: position.lat, longitude: position.lng };
                });
                
                // Set initial location
                locationData = { latitude: initialCoords[0], longitude: initialCoords[1] };
            }

            function showAddressModal() {
                paymentModal.classList.add('hidden');
                bankTransferModal.classList.add('hidden');
                addressModal.classList.remove('hidden');
                // Use timeout to ensure map container is visible before initializing
                setTimeout(() => initializeMap(), 100);
            }

            async function submitFinalOrder() {
                const addressDetails = addressDetailsInput.value.trim();
                if (!locationData) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö'); return; }
                if (!addressDetails) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö'); return; }
                let messageText = "üîî ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö\n\n--- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ---\n";
                let totalPrice = 0;
                const groupedCart = cart.reduce((acc, item) => { if (!acc[item.id]) { acc[item.id] = { ...item, quantity: 0 }; } acc[item.id].quantity++; return acc; }, {});
                Object.values(groupedCart).forEach(item => { messageText += `- ${item.name} x${item.quantity} = ${item.price * item.quantity} ‡∏ö.\n`; totalPrice += item.price * item.quantity; });
                messageText += `\n‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${totalPrice} ‡∏ö‡∏≤‡∏ó`;
                messageText += `\n‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô: ${paymentMethod}`;
                messageText += `\n\n--- ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á ---\n${addressDetails}`;
                const locationMessage = `https://www.google.com/maps?q=${locationData.latitude},${locationData.longitude}`;
                try {
                    await liff.sendMessages([{ type: 'text', text: messageText }, { type: 'text', text: `üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ${locationMessage}` }]);
                    alert("‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                    liff.closeWindow();
                } catch (error) { console.error('Send message failed', error); }
            }

            // --- Event Listeners ---
            menuListEl.addEventListener('click', (e) => { const btn = e.target.closest('.btn-add'); if(btn) { const itemId = btn.dataset.id; const selectedItem = menuItems.find(item => item.id == itemId); cart.push(selectedItem); renderCart(); }});
            cartBtn.addEventListener('click', () => { if (cart.length > 0) orderSummaryEl.classList.remove('hidden'); else alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö'); });
            closeCartBtn.addEventListener('click', () => { orderSummaryEl.classList.add('hidden'); });
            confirmOrderBtn.addEventListener('click', () => { orderSummaryEl.classList.add('hidden'); paymentModal.classList.remove('hidden'); });
            codBtn.addEventListener('click', () => { paymentMethod = '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á'; showAddressModal(); });
            bankTransferBtn.addEventListener('click', () => { paymentMethod = '‡πÇ‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£'; paymentModal.classList.add('hidden'); bankTransferModal.classList.remove('hidden'); });
            slipUploadInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => { slipPreviewImg.src = event.target.result; slipPreviewContainer.classList.remove('hidden'); setTimeout(() => { showAddressModal(); }, 500); }; reader.readAsDataURL(file); } });
            
            // Event listener for the "Find Me" button
            findMeBtn.addEventListener('click', async () => {
                try {
                    const location = await liff.getGeolocation();
                    const coords = { lat: location.coords.latitude, lng: location.coords.longitude };
                    locationData = { latitude: coords.lat, longitude: coords.lng };
                    map.setView(coords, 17); // Zoom in on the user's location
                    marker.setLatLng(coords);
                } catch (error) {
                    console.error(error);
                    alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á\n\n‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: ${error.code || error.message}`);
                }
            });

            submitFinalOrderBtn.addEventListener('click', submitFinalOrder);
            main();
        });
    </script>
</body>
</html>
